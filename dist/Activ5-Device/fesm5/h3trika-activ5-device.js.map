{"version":3,"file":"h3trika-activ5-device.js.map","sources":["ng://@h3trika/activ5-device/a5-device-manager.ts"],"sourcesContent":["/// <reference path=\"index.d.ts\" />\n\nimport { Injectable } from '@angular/core';\nimport { Observable, Subject } from 'rxjs';\n\nenum DeviceUUID {\n  SERVICE = '00005000-0000-1000-8000-00805f9b34fb',\n  READ = '00005a01-0000-1000-8000-00805f9b34fb',\n  WRITE = '00005a02-0000-1000-8000-00805f9b34fb'\n}\n\nenum DeviceCommands {\n  TVGTIME = 'TVGTIME',\n  ISOM = 'ISOM!',\n  TARE = 'TARE!',\n  STOP = 'STOP!'\n}\n\nenum DeviceState {\n  handshake = 'handshake',\n  isometric = 'isometric',\n  stop = 'stop',\n  disconnected = 'disconnected'\n}\n\n@Injectable({\n  providedIn: 'root'\n})\n\nexport class A5DeviceManager {\n\n  private device: BluetoothDevice;\n  private deviceAsObservable = new Subject<BluetoothDevice>();\n\n  private server: BluetoothRemoteGATTServer;\n  private service: BluetoothRemoteGATTService;\n\n  private isomDataAsObservable = new Subject<string>();\n\n  private evergreenModeTimer: number;\n  private characteristics = new Map();\n  private deviceState = DeviceState.disconnected;\n\n  public getDevice(): Observable<BluetoothDevice> {\n    return this.deviceAsObservable.asObservable();\n  }\n\n  public getIsometricData(): Observable<string> {\n    return this.isomDataAsObservable.asObservable();\n  }\n\n  public async connect(): Promise<void> {\n\n    if (window.navigator && window.navigator.bluetooth) {\n      let device: BluetoothDevice;\n\n      if (!this.device) {\n        device = await navigator.bluetooth.requestDevice({ filters: [{ services: [DeviceUUID.SERVICE] }] });\n      }\n\n      if (!this.server) {\n        this.server = await device.gatt.connect();\n      }\n\n      if (!this.service) {\n        this.service = await this.server.getPrimaryService(DeviceUUID.SERVICE);\n      }\n\n      await this.cacheCharacteristic(DeviceUUID.READ);\n      await this.cacheCharacteristic(DeviceUUID.WRITE);\n\n      await this.writeCharacteristicValue(this.formatCommand(DeviceCommands.TVGTIME));\n\n      this.deviceAsObservable.next(device);\n      this.device = device;\n      this.deviceState = DeviceState.handshake;\n    }\n  }\n\n  public async startIsometric(): Promise<void> {\n    await this.writeCharacteristicValue(this.formatCommand(DeviceCommands.ISOM));\n    this.deviceState = DeviceState.isometric;\n\n    const characteristic = await this.startNotifications();\n    this.attachListener(characteristic);\n  }\n\n  public tare(): void {\n    this.writeCharacteristicValue(this.formatCommand(DeviceCommands.TARE));\n  }\n\n  public async stop(): Promise<void> {\n    await this.writeCharacteristicValue(this.formatCommand(DeviceCommands.STOP));\n    this.deviceState = DeviceState.stop;\n  }\n\n  public evergreenMode(isEvergreenMode: boolean): void {\n    if (isEvergreenMode) {\n      this.evergreenModeTimer = window.setInterval(() => {\n        switch (this.deviceState) {\n          case DeviceState.stop: case DeviceState.handshake:\n            this.stop();\n            break;\n          default:\n            break;\n        }\n      }, 60000);\n    } else {\n      clearInterval(this.evergreenModeTimer);\n    }\n  }\n\n  public async disconnect(): Promise<void> {\n    await this.device.gatt.disconnect();\n    this.device = undefined;\n    this.server = undefined;\n    this.service = undefined;\n    this.deviceAsObservable.next(undefined);\n  }\n\n  private async cacheCharacteristic(characteristicUuid: string): Promise<void> {\n    const characteristic = await this.service.getCharacteristic(characteristicUuid);\n    this.characteristics.set(characteristicUuid, characteristic);\n  }\n\n  private writeCharacteristicValue(value: DataView): Promise<void> {\n    const characteristic = this.characteristics.get(DeviceUUID.WRITE);\n    return characteristic.writeValue(value);\n  }\n\n  private startNotifications(): Promise<BluetoothRemoteGATTCharacteristic> {\n    const characteristic = this.characteristics.get(DeviceUUID.READ);\n    return characteristic.startNotifications();\n  }\n\n  private attachListener(characteristic: BluetoothRemoteGATTCharacteristic): void {\n    characteristic.addEventListener('characteristicvaluechanged', event => {\n      const target = event.target as BluetoothRemoteGATTCharacteristic;\n      this.parseData(target.value);\n    });\n  }\n\n  private parseData(data: DataView): void {\n    const deviceDataAsString = String.fromCharCode.apply(null, new Uint8Array(data.buffer));\n    const isomData = deviceDataAsString.match(/IS(.*)\\/IS/)[1];\n\n    this.isomDataAsObservable.next(isomData);\n  }\n\n  private formatCommand(type: string): DataView {\n    const buffer = new ArrayBuffer(type.length + 2);\n    const dataView = new DataView(buffer, 0);\n\n    dataView.setUint8(0, 65);\n\n    for (let i = 0; i < type.length; i++) {\n        dataView.setUint8(i + 1, type.charCodeAt(i));\n    }\n\n    dataView.setUint8(type.length + 1, 25);\n\n    return dataView;\n  }\n\n}\n"],"names":[],"mappings":";;;;;;;;;;IAME,SAAU,sCAAsC;IAChD,MAAO,sCAAsC;IAC7C,OAAQ,sCAAsC;;;;IAI9C,SAAU,SAAS;IACnB,MAAO,OAAO;IACd,MAAO,OAAO;IACd,MAAO,OAAO;;;;IAId,WAAY,WAAW;IACvB,WAAY,WAAW;IACvB,MAAO,MAAM;IACb,cAAe,cAAc;;AAG/B;IAAA;QAOU,uBAAkB,GAAG,IAAI,OAAO,EAAmB,CAAC;QAKpD,yBAAoB,GAAG,IAAI,OAAO,EAAU,CAAC;QAG7C,oBAAe,GAAG,IAAI,GAAG,EAAE,CAAC;QAC5B,gBAAW,GAAG,WAAW,CAAC,YAAY,CAAC;KA2HhD;;;;IAzHQ,mCAAS;;;IAAhB;QACE,OAAO,IAAI,CAAC,kBAAkB,CAAC,YAAY,EAAE,CAAC;KAC/C;;;;IAEM,0CAAgB;;;IAAvB;QACE,OAAO,IAAI,CAAC,oBAAoB,CAAC,YAAY,EAAE,CAAC;KACjD;;;;IAEY,iCAAO;;;IAApB;;;;;;8BAEM,MAAM,CAAC,SAAS,IAAI,MAAM,CAAC,SAAS,CAAC,SAAS,CAAA,EAA9C,yBAA8C;wBAC5C,MAAM,SAAiB;6BAEvB,CAAC,IAAI,CAAC,MAAM,EAAZ,wBAAY;wBACL,qBAAM,SAAS,CAAC,SAAS,CAAC,aAAa,CAAC,EAAE,OAAO,EAAE,CAAC,EAAE,QAAQ,EAAE,CAAC,UAAU,CAAC,OAAO,CAAC,EAAE,CAAC,EAAE,CAAC,EAAA;;wBAAnG,MAAM,GAAG,SAA0F,CAAC;;;6BAGlG,CAAC,IAAI,CAAC,MAAM,EAAZ,wBAAY;wBACd,KAAA,IAAI,CAAA;wBAAU,qBAAM,MAAM,CAAC,IAAI,CAAC,OAAO,EAAE,EAAA;;wBAAzC,GAAK,MAAM,GAAG,SAA2B,CAAC;;;6BAGxC,CAAC,IAAI,CAAC,OAAO,EAAb,wBAAa;wBACf,KAAA,IAAI,CAAA;wBAAW,qBAAM,IAAI,CAAC,MAAM,CAAC,iBAAiB,CAAC,UAAU,CAAC,OAAO,CAAC,EAAA;;wBAAtE,GAAK,OAAO,GAAG,SAAuD,CAAC;;4BAGzE,qBAAM,IAAI,CAAC,mBAAmB,CAAC,UAAU,CAAC,IAAI,CAAC,EAAA;;wBAA/C,SAA+C,CAAC;wBAChD,qBAAM,IAAI,CAAC,mBAAmB,CAAC,UAAU,CAAC,KAAK,CAAC,EAAA;;wBAAhD,SAAgD,CAAC;wBAEjD,qBAAM,IAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,aAAa,CAAC,cAAc,CAAC,OAAO,CAAC,CAAC,EAAA;;wBAA/E,SAA+E,CAAC;wBAEhF,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;wBACrC,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;wBACrB,IAAI,CAAC,WAAW,GAAG,WAAW,CAAC,SAAS,CAAC;;;;;;KAE5C;;;;IAEY,wCAAc;;;IAA3B;;;;;4BACE,qBAAM,IAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,aAAa,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC,EAAA;;wBAA5E,SAA4E,CAAC;wBAC7E,IAAI,CAAC,WAAW,GAAG,WAAW,CAAC,SAAS,CAAC;wBAElB,qBAAM,IAAI,CAAC,kBAAkB,EAAE,EAAA;;wBAAhD,cAAc,GAAG,SAA+B;wBACtD,IAAI,CAAC,cAAc,CAAC,cAAc,CAAC,CAAC;;;;;KACrC;;;;IAEM,8BAAI;;;IAAX;QACE,IAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,aAAa,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC,CAAC;KACxE;;;;IAEY,8BAAI;;;IAAjB;;;;4BACE,qBAAM,IAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,aAAa,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC,EAAA;;wBAA5E,SAA4E,CAAC;wBAC7E,IAAI,CAAC,WAAW,GAAG,WAAW,CAAC,IAAI,CAAC;;;;;KACrC;;;;;IAEM,uCAAa;;;;IAApB,UAAqB,eAAwB;QAA7C,iBAcC;QAbC,IAAI,eAAe,EAAE;YACnB,IAAI,CAAC,kBAAkB,GAAG,MAAM,CAAC,WAAW;;;YAAC;gBAC3C,QAAQ,KAAI,CAAC,WAAW;oBACtB,KAAK,WAAW,CAAC,IAAI,CAAC;oBAAC,KAAK,WAAW,CAAC,SAAS;wBAC/C,KAAI,CAAC,IAAI,EAAE,CAAC;wBACZ,MAAM;oBACR;wBACE,MAAM;iBACT;aACF,GAAE,KAAK,CAAC,CAAC;SACX;aAAM;YACL,aAAa,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC;SACxC;KACF;;;;IAEY,oCAAU;;;IAAvB;;;;4BACE,qBAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,EAAE,EAAA;;wBAAnC,SAAmC,CAAC;wBACpC,IAAI,CAAC,MAAM,GAAG,SAAS,CAAC;wBACxB,IAAI,CAAC,MAAM,GAAG,SAAS,CAAC;wBACxB,IAAI,CAAC,OAAO,GAAG,SAAS,CAAC;wBACzB,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;;;;;KACzC;;;;;;IAEa,6CAAmB;;;;;IAAjC,UAAkC,kBAA0B;;;;;4BACnC,qBAAM,IAAI,CAAC,OAAO,CAAC,iBAAiB,CAAC,kBAAkB,CAAC,EAAA;;wBAAzE,cAAc,GAAG,SAAwD;wBAC/E,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,kBAAkB,EAAE,cAAc,CAAC,CAAC;;;;;KAC9D;;;;;;IAEO,kDAAwB;;;;;IAAhC,UAAiC,KAAe;;YACxC,cAAc,GAAG,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,UAAU,CAAC,KAAK,CAAC;QACjE,OAAO,cAAc,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC;KACzC;;;;;IAEO,4CAAkB;;;;IAA1B;;YACQ,cAAc,GAAG,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,UAAU,CAAC,IAAI,CAAC;QAChE,OAAO,cAAc,CAAC,kBAAkB,EAAE,CAAC;KAC5C;;;;;;IAEO,wCAAc;;;;;IAAtB,UAAuB,cAAiD;QAAxE,iBAKC;QAJC,cAAc,CAAC,gBAAgB,CAAC,4BAA4B;;;;QAAE,UAAA,KAAK;;gBAC3D,MAAM,sBAAG,KAAK,CAAC,MAAM,EAAqC;YAChE,KAAI,CAAC,SAAS,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;SAC9B,EAAC,CAAC;KACJ;;;;;;IAEO,mCAAS;;;;;IAAjB,UAAkB,IAAc;;YACxB,kBAAkB,GAAG,MAAM,CAAC,YAAY,CAAC,KAAK,CAAC,IAAI,EAAE,IAAI,UAAU,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;;YACjF,QAAQ,GAAG,kBAAkB,CAAC,KAAK,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;QAE1D,IAAI,CAAC,oBAAoB,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;KAC1C;;;;;;IAEO,uCAAa;;;;;IAArB,UAAsB,IAAY;;YAC1B,MAAM,GAAG,IAAI,WAAW,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC;;YACzC,QAAQ,GAAG,IAAI,QAAQ,CAAC,MAAM,EAAE,CAAC,CAAC;QAExC,QAAQ,CAAC,QAAQ,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC;QAEzB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;YAClC,QAAQ,CAAC,QAAQ,CAAC,CAAC,GAAG,CAAC,EAAE,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC;SAChD;QAED,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,EAAE,EAAE,CAAC,CAAC;QAEvC,OAAO,QAAQ,CAAC;KACjB;;gBAzIF,UAAU,SAAC;oBACV,UAAU,EAAE,MAAM;iBACnB;;;0BA3BD;CAyBA;;;;;;;;;;;;;;"}
