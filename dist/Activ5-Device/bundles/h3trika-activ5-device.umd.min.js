!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("rxjs")):"function"==typeof define&&define.amd?define("@h3trika/activ5-device",["exports","@angular/core","rxjs"],t):t((e.h3trika=e.h3trika||{},e.h3trika["activ5-device"]={}),e.ng.core,e.rxjs)}(this,function(e,t,r){"use strict";function n(t,c,s,o){return new(s=s||Promise)(function(e,r){function n(e){try{a(o.next(e))}catch(t){r(t)}}function i(e){try{a(o["throw"](e))}catch(t){r(t)}}function a(t){t.done?e(t.value):new s(function(e){e(t.value)}).then(n,i)}a((o=o.apply(t,c||[])).next())})}function i(n,i){var a,c,s,e,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),"throw":t(1),"return":t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function r(e){if(a)throw new TypeError("Generator is already executing.");for(;o;)try{if(a=1,c&&(s=2&e[0]?c["return"]:e[0]?c["throw"]||((s=c["return"])&&s.call(c),0):c.next)&&!(s=s.call(c,e[1])).done)return s;switch(c=0,s&&(e=[2&e[0],s.value]),e[0]){case 0:case 1:s=e;break;case 4:return o.label++,{value:e[1],done:!1};case 5:o.label++,c=e[1],e=[0];continue;case 7:e=o.ops.pop(),o.trys.pop();continue;default:if(!(s=0<(s=o.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){o=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3])){o.label=e[1];break}if(6===e[0]&&o.label<s[1]){o.label=s[1],s=e;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(e);break}s[2]&&o.ops.pop(),o.trys.pop();continue}e=i.call(n,o)}catch(t){e=[6,t],c=0}finally{a=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([t,e])}}}var a="00005000-0000-1000-8000-00805f9b34fb",c="00005a01-0000-1000-8000-00805f9b34fb",s="00005a02-0000-1000-8000-00805f9b34fb",o="TVGTIME",u="ISOM!",h="TARE!",f="STOP!",l="handshake",v="isometric",d="stop",p="disconnected",b=(y.prototype.getIsometricData=function(){return this.isomDataAsObservable.asObservable()},y.prototype.onDisconnect=function(){return this.disconnectEventAsObservable.asObservable()},y.prototype.connect=function(){return n(this,void 0,void 0,function(){var t,r,n;return i(this,function(e){switch(e.label){case 0:return window.navigator&&window.navigator.bluetooth?(t=void 0,this.device?[3,2]:[4,navigator.bluetooth.requestDevice({filters:[{services:[a]}]})]):[3,10];case 1:t=e.sent(),e.label=2;case 2:return this.server?[3,4]:(r=this,[4,t.gatt.connect()]);case 3:r.server=e.sent(),e.label=4;case 4:return this.service?[3,6]:[4,(n=this).server.getPrimaryService(a)];case 5:n.service=e.sent(),e.label=6;case 6:return[4,this.cacheCharacteristic(c)];case 7:return e.sent(),[4,this.cacheCharacteristic(s)];case 8:return e.sent(),[4,this.writeCharacteristicValue(this.formatCommand(o))];case 9:return e.sent(),this.device=t,this.deviceState=l,this.attachDisconnectListener(),[2,this.device];case 10:return[2]}})})},y.prototype.startIsometric=function(){return n(this,void 0,void 0,function(){var t;return i(this,function(e){switch(e.label){case 0:return[4,this.writeCharacteristicValue(this.formatCommand(u))];case 1:return e.sent(),this.deviceState=v,[4,this.startNotifications()];case 2:return t=e.sent(),this.attachIsometricListener(t),[2]}})})},y.prototype.tare=function(){this.writeCharacteristicValue(this.formatCommand(h))},y.prototype.stop=function(){return n(this,void 0,void 0,function(){return i(this,function(e){switch(e.label){case 0:return[4,this.writeCharacteristicValue(this.formatCommand(f))];case 1:return e.sent(),this.deviceState=d,[2]}})})},y.prototype.evergreenMode=function(e){var t=this;e?this.evergreenModeTimer=window.setInterval(function(){switch(t.deviceState){case d:case l:t.stop()}},6e4):clearInterval(this.evergreenModeTimer)},y.prototype.disconnect=function(){this.device.gatt.disconnect()},y.prototype.attachDisconnectListener=function(){var t=this;this.device.addEventListener("gattserverdisconnected",function(e){t.disconnectEventAsObservable.next(e),t.deviceState=p,t.device=undefined,t.server=undefined,t.service=undefined})},y.prototype.cacheCharacteristic=function(r){return n(this,void 0,void 0,function(){var t;return i(this,function(e){switch(e.label){case 0:return[4,this.service.getCharacteristic(r)];case 1:return t=e.sent(),this.characteristics.set(r,t),[2]}})})},y.prototype.writeCharacteristicValue=function(e){return this.characteristics.get(s).writeValue(e)},y.prototype.startNotifications=function(){return this.characteristics.get(c).startNotifications()},y.prototype.attachIsometricListener=function(e){var r=this;e.addEventListener("characteristicvaluechanged",function(e){var t=e.target;r.parseData(t.value)})},y.prototype.parseData=function(e){var t=String.fromCharCode.apply(null,new Uint8Array(e.buffer)).match(/IS(.*)\/IS/)[1];this.isomDataAsObservable.next(t)},y.prototype.formatCommand=function(e){var t=new ArrayBuffer(e.length+2),r=new DataView(t,0);r.setUint8(0,65);for(var n=0;n<e.length;n++)r.setUint8(n+1,e.charCodeAt(n));return r.setUint8(e.length+1,25),r},y.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],y.ngInjectableDef=t.defineInjectable({factory:function(){return new y},token:y,providedIn:"root"}),y);function y(){this.disconnectEventAsObservable=new r.Subject,this.isomDataAsObservable=new r.Subject,this.characteristics=new Map,this.deviceState=p}e.A5DeviceManager=b,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=h3trika-activ5-device.umd.min.js.map