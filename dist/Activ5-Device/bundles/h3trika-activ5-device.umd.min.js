!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("rxjs")):"function"==typeof define&&define.amd?define("@h3trika/activ5-device",["exports","@angular/core","rxjs"],t):t((e.h3trika=e.h3trika||{},e.h3trika["activ5-device"]={}),e.ng.core,e.rxjs)}(this,function(e,t,r){"use strict";function i(t,s,c,o){return new(c=c||Promise)(function(e,r){function i(e){try{a(o.next(e))}catch(t){r(t)}}function n(e){try{a(o["throw"](e))}catch(t){r(t)}}function a(t){t.done?e(t.value):new c(function(e){e(t.value)}).then(i,n)}a((o=o.apply(t,s||[])).next())})}function n(i,n){var a,s,c,e,o={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]};return e={next:t(0),"throw":t(1),"return":t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function r(e){if(a)throw new TypeError("Generator is already executing.");for(;o;)try{if(a=1,s&&(c=2&e[0]?s["return"]:e[0]?s["throw"]||((c=s["return"])&&c.call(s),0):s.next)&&!(c=c.call(s,e[1])).done)return c;switch(s=0,c&&(e=[2&e[0],c.value]),e[0]){case 0:case 1:c=e;break;case 4:return o.label++,{value:e[1],done:!1};case 5:o.label++,s=e[1],e=[0];continue;case 7:e=o.ops.pop(),o.trys.pop();continue;default:if(!(c=0<(c=o.trys).length&&c[c.length-1])&&(6===e[0]||2===e[0])){o=0;continue}if(3===e[0]&&(!c||e[1]>c[0]&&e[1]<c[3])){o.label=e[1];break}if(6===e[0]&&o.label<c[1]){o.label=c[1],c=e;break}if(c&&o.label<c[2]){o.label=c[2],o.ops.push(e);break}c[2]&&o.ops.pop(),o.trys.pop();continue}e=n.call(i,o)}catch(t){e=[6,t],s=0}finally{a=c=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([t,e])}}}var a="00005000-0000-1000-8000-00805f9b34fb",s="00005a01-0000-1000-8000-00805f9b34fb",c="00005a02-0000-1000-8000-00805f9b34fb",o="TVGTIME",u="ISOM!",h="TARE!",f="STOP!",l="handshake",v="isometric",d="stop",p="disconnected",b=(y.prototype.getDevice=function(){return this.deviceAsObservable.asObservable()},y.prototype.getIsometricData=function(){return this.isomDataAsObservable.asObservable()},y.prototype.connect=function(){return i(this,void 0,void 0,function(){var t,r,i;return n(this,function(e){switch(e.label){case 0:return window.navigator&&window.navigator.bluetooth?(t=void 0,this.device?[3,2]:[4,navigator.bluetooth.requestDevice({filters:[{services:[a]}]})]):[3,10];case 1:t=e.sent(),e.label=2;case 2:return this.server?[3,4]:(r=this,[4,t.gatt.connect()]);case 3:r.server=e.sent(),e.label=4;case 4:return this.service?[3,6]:[4,(i=this).server.getPrimaryService(a)];case 5:i.service=e.sent(),e.label=6;case 6:return[4,this.cacheCharacteristic(s)];case 7:return e.sent(),[4,this.cacheCharacteristic(c)];case 8:return e.sent(),[4,this.writeCharacteristicValue(this.formatCommand(o))];case 9:e.sent(),this.deviceAsObservable.next(t),this.device=t,this.deviceState=l,e.label=10;case 10:return[2]}})})},y.prototype.startIsometric=function(){return i(this,void 0,void 0,function(){var t;return n(this,function(e){switch(e.label){case 0:return[4,this.writeCharacteristicValue(this.formatCommand(u))];case 1:return e.sent(),this.deviceState=v,[4,this.startNotifications()];case 2:return t=e.sent(),this.attachListener(t),[2]}})})},y.prototype.tare=function(){this.writeCharacteristicValue(this.formatCommand(h))},y.prototype.stop=function(){return i(this,void 0,void 0,function(){return n(this,function(e){switch(e.label){case 0:return[4,this.writeCharacteristicValue(this.formatCommand(f))];case 1:return e.sent(),this.deviceState=d,[2]}})})},y.prototype.evergreenMode=function(e){var t=this;e?this.evergreenModeTimer=window.setInterval(function(){switch(t.deviceState){case d:case l:t.stop()}},6e4):clearInterval(this.evergreenModeTimer)},y.prototype.disconnect=function(){return i(this,void 0,void 0,function(){return n(this,function(e){switch(e.label){case 0:return[4,this.device.gatt.disconnect()];case 1:return e.sent(),this.device=undefined,this.server=undefined,this.service=undefined,this.deviceAsObservable.next(undefined),[2]}})})},y.prototype.cacheCharacteristic=function(r){return i(this,void 0,void 0,function(){var t;return n(this,function(e){switch(e.label){case 0:return[4,this.service.getCharacteristic(r)];case 1:return t=e.sent(),this.characteristics.set(r,t),[2]}})})},y.prototype.writeCharacteristicValue=function(e){return this.characteristics.get(c).writeValue(e)},y.prototype.startNotifications=function(){return this.characteristics.get(s).startNotifications()},y.prototype.attachListener=function(e){var r=this;e.addEventListener("characteristicvaluechanged",function(e){var t=e.target;r.parseData(t.value)})},y.prototype.parseData=function(e){var t=String.fromCharCode.apply(null,new Uint8Array(e.buffer)).match(/IS(.*)\/IS/)[1];this.isomDataAsObservable.next(t)},y.prototype.formatCommand=function(e){var t=new ArrayBuffer(e.length+2),r=new DataView(t,0);r.setUint8(0,65);for(var i=0;i<e.length;i++)r.setUint8(i+1,e.charCodeAt(i));return r.setUint8(e.length+1,25),r},y.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],y.ngInjectableDef=t.defineInjectable({factory:function(){return new y},token:y,providedIn:"root"}),y);function y(){this.deviceAsObservable=new r.Subject,this.isomDataAsObservable=new r.Subject,this.characteristics=new Map,this.deviceState=p}e.A5DeviceManager=b,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=h3trika-activ5-device.umd.min.js.map